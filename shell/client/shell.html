<!--
Sandstorm - Personal Cloud Sandbox
Copyright (c) 2014 Sandstorm Development Group, Inc. and contributors
All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<head>
  <title>Sandstorm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
</body>

<template name="layout">
  {{>sandstormTopbar globalTopbar}}

  {{#with demoExpired}}
    {{>title "Demo Expired"}}

    <div id="demo-expired" class="demo-expired-main-content {{#if hideNavbar}}hide-navbar{{else}}{{#if shrinkNavbar}}shrink-navbar{{/if}}{{/if}}">
      <h1>Demo Expired</h1>
      {{#if canUpgradeDemo}}
        <p>Thanks for trying the Sandstorm Demo! Your demo account has expired. If
          you'd like to continue using Sandstorm and make your data permanent, please sign in.</p>
        <div class="login">
          {{> loginButtonsDialog globalAccountsUi}}
        </div>
      {{else}}
        <p>Thanks for trying the Sandstorm Demo! Your demo account has expired.</p>
        <p><button class="logout">Sign out</button></p>
      {{/if}}
    </div>
  {{else}}
  {{#if identityUser}}
      {{> identityLoginInterstitial}}
  {{else}}
  {{#if firstLogin}}
    <div class="first-sign-in-main-content {{#if hideNavbar}}hide-navbar{{else}}{{#if shrinkNavbar}}shrink-navbar{{/if}}{{/if}}">
      {{> sandstormAccountsFirstSignIn accountSettingsUi}}
    </div>
  {{else}}
  {{#with firstTimeBillingPromptState}}
    <div class="first-sign-in-main-content {{#if hideNavbar}}hide-navbar{{else}}{{#if shrinkNavbar}}shrink-navbar{{/if}}{{/if}}">
      {{> billingPromptFirstTime}}
    </div>
  {{else}}

  {{!-- standard topbar items --}}
  {{#sandstormTopbarItem name="home-button" topbar=globalTopbar}}
    <a href="/">Sandstorm</a>
  {{/sandstormTopbarItem}}
  {{#if showAccountButtons}}
    {{>sandstormTopbarItem name="account" topbar=globalTopbar data=accountButtonsData
                           template="accountButtons" popupTemplate="accountButtonsPopup"}}
  {{else}}
    {{>sandstormTopbarItem name="login" topbar=globalTopbar data=globalAccountsUi
                           template="loginButtons" popupTemplate="loginButtonsPopup"}}
  {{/if}}
  {{#if currentUser}}
    {{>sandstormTopbarItem name="notifications" topbar=globalTopbar
                           template="notifications" popupTemplate="notificationsPopup"
                           priority=-1}}
  {{/if}}
  {{!-- admin alerts --}}
  {{#with adminAlert}}
    {{#if adminAlertIsTooLarge}}
      {{#sandstormTopbarItem name="admin-alert" topbar=globalTopbar priority=-2}}
        {{!-- TODO(cleaup): Awkwardly, the event handlers on Template.layout actually work
            on this topbar item solely because the whole topbar itself is embedded inside the
            "layout" template. But, we shouldn't be relying on that! Move this to its own
            template... --}}
        <span id="admin-alert-icon" class="{{className}}">!</span>
      {{else}}
        <h4>Notice from Admin</h4>
        <p>
          {{#if alertUrl}}
            <a href="{{alertUrl}}" class="alert {{className}}">{{text}}</a>
          {{else}}
            <span class="alert {{className}}">{{text}}</span>
          {{/if}}
        </p>
      {{/sandstormTopbarItem}}
    {{else}}
      {{#sandstormTopbarItem name="admin-alert" topbar=globalTopbar}}
        {{#if alertUrl}}
          <a href="{{alertUrl}}" class="alert {{className}}">{{text}}</a>
        {{else}}
          <span class="alert {{className}}">{{text}}</span>
        {{/if}}
      {{/sandstormTopbarItem}}
    {{/if}}
  {{/with}}

  {{#with billingPromptState}}
    {{>billingPrompt}}
  {{/with}}

  {{/with}} {{!-- firstTimeBillingPromptState --}}
  {{/if}} {{!-- firstLogin --}}
  {{/if}} {{!-- identityUser --}}
  {{/with}} {{!-- demoExpired --}}

  {{!-- Make sure to always render the main-content div, but only yield if there is no interstitial
        to render on top. The main-content div needs to be stable so that any GrainView that gets
        attached does not get orphaned. For example, if the main-content div were inside the
        {{#if firstLogin}} block, then grain views could appear to become blanked out when a demo
        user upgrades to a real account by linking an email identity.
   --}}
  <div class="main-content {{#if hideNavbar}}hide-navbar{{else}}{{#if shrinkNavbar}}shrink-navbar{{/if}}{{/if}}">
  {{#unless demoExpired}}
    {{#unless identityUser}}
      {{#unless firstLogin}}
        {{#unless firstTimeBillingPromptState}}
          {{> yield}}
        {{/unless}}
      {{/unless}}
    {{/unless}}
  {{/unless}}
  </div>

</template>

<template name="grainView">
  {{!-- This template is rendered manually using Blaze.renderWithData() for each currently-open
        grain and then injected into .main-content. We do things manually so that we can be
        sure that adding or removing grains from the open grain list does not cause other grains'
        iframes to be re-rendered, losing state. --}}
  {{#with unpackedGrainState}}
    <div class="grain-container {{#if active}}active-grain{{else}}inactive-grain{{/if}}">
    {{#if error}}
      {{#if unauthorized}}
        {{#if token}}
          {{> revokedShareLink}}
        {{else}}
          {{> requestAccess}}
        {{/if}}
      {{else}}
        {{#if notFound}}
           <p class="grain-not-found grain-interstitial">
             No grain found with ID "{{grainId}}".
           </p>
        {{else}}
          <pre>{{error}}</pre>
        {{/if}}
      {{/if}}
    {{else}}
    {{#if appOrigin}}
      {{!-- Selenium requires iframes to have an id in order to select them. id="grain-frame" is only
            used for testing purposes. --}}
      <iframe data-grainid="{{grainId}}" id="grain-frame" class="grain-frame" src="{{appOrigin}}/_sandstorm-init?sessionid={{sessionId}}&path={{originalPath}}"></iframe>
      {{#if hasNotLoaded}}
        {{> _grainSpinner}}
      {{/if}}
    {{else}}
    {{#if interstitial.chooseIdentity}}
      <div class="grain-interstitial">
        <p>With which of your identities would you like to open this grain?</p>
        {{> identityPicker identityPickerData}}
        <button class="incognito-button" data-token="{{token}}">Open in Incognito Mode</button>
      </div>
    {{else}}
      {{#if interstitial.directShare}}
        <div class="grain-interstitial">
          <p>
            Access through this URL is restricted to this identity:
          </p>
          {{> identityCard interstitial.directShare.recipient }}
          {{#if currentUser}}
            <p>
              To gain access,
              <a href="/account">link the above identity to your account</a>
              or sign in with the appropriate account.
            </p>
          {{else}}
            <p>
              Please sign in to gain access.
            </p>
          {{/if}}
        </div>
      {{else}}
        {{> _grainSpinner}}
      {{/if}}
    {{/if}}
    {{/if}}
    {{/if}}
    </div>
  {{/with}}
</template>

<template name="requestAccess">
  <div class="request-access grain-interstitial">
  <p>You do not have permission to access this grain.</p>
  {{#if currentUser}}
    {{#with status}}
      {{#if showButton}}
        <button class="request-access" title="Request access">
          Request Access
        </button>
      {{/if}}
      {{#if chooseIdentity}}
        <p>Requesting access will reveal your identity to the grain owner.</p>
        <p> {{chooseIdentityText}} </p>
        {{> identityPicker identityPickerData}}
      {{/if}}
      {{#if waiting}}
         <p>Sending your request...</p>
      {{/if}}
      {{#if success}}
        <p>
          Your request has been sent. You will receive an email if your request is approved.
        </p>
      {{/if}}
      {{#with error}}
        <p>Your request failed because: {{.}}</p>
      {{/with}}
    {{/with}}
  {{else}}
    Please sign in to request access.
  {{/if}}
  </div>
</template>

<template name="invalidToken">
   <pre> Invalid token: {{token}} </pre>
</template>

<template name="revokedShareLink">
  <p class="grain-interstitial">Sorry, this link has been revoked.</p>
</template>

<template name="noLayout">
  {{!-- An empty layout for resource windows e.g. grainLog that we want to put reactive stuff in,
   but don't need the topbar and reload blocking and other fanciness that the layout gives --}}
  {{> yield}}
</template>

<template name="notifications">
  <button class="show-popup" title="Notifications">
  {{#if notificationCount}}
    <span class="count">{{notificationCount}}</span>
  {{/if}}
  Notifications
  </button>
</template>

<template name="notificationsPopup">
  <h4>Notifications</h4>
  <ul class="notification-list">
    {{#each notifications}}
      <li>
        {{> notificationItem}}
      </li>
    {{else}}
    <li>No Notifications...</li>
    {{/each}}
  </ul>
</template>

<template name="notificationItem">
  <div class="notification-item">
    {{#if notificationTitle}}
      <div class="notification-title">
        {{notificationTitle}}:
      </div>
    {{/if}}
    {{#if isAppUpdates}}
      <ul class="app-updates">
      {{#each appUpdatesList}}
        <li><b>{{name}}</b>: version {{marketingVersion}} is available</li>
      {{/each}}
      </ul>
    {{else}}
      {{#if adminLink}}
        <a href="{{adminLink}}">{{text.defaultText}}</a>
      {{else}}
        {{#if referral}}
          {{#if paidUser}}
            Get up to 30 GB bonus with the
          {{else}}
            Unlimited grains &amp; up to 2 GB bonus with the
          {{/if}}
          {{#linkTo route="referrals" class="dismiss-notification"}}
            referral program &raquo;
          {{/linkTo}}
        {{else}}
          {{#if mailingListBonus}}
            {{> mailingListBonusNotification}}
          {{else}}
            {{text.defaultText}}
          {{/if}}
        {{/if}}
      {{/if}}
    {{/if}}
    <div class="notification-footer">
      <span title="{{timestamp}}" class="notification-timestamp">{{dateString timestamp}}</span>
      {{#if isAppUpdates}}
        <button title="Ignore the above updates" class="cancel-notification">Dismiss</button>
        <button title="Update all of the above apps" class="accept-notification">Apply Updates</button>
      {{else}}
        {{#if mailingListBonus}}
          {{> mailingListBonusNotificationButtons}}
        {{else}}
          {{#if dismissText}}
            <button title="{{titleHelperText}}" class="cancel-notification">{{dismissText}}</button>
          {{/if}}
        {{/if}}
      {{/if}}
    </div>
  </div>
</template>

<template name="title">
  {{#sandstormTopbarItem name="title" priority=5 topbar=globalTopbar}}{{.}}{{/sandstormTopbarItem}}
</template>

<template name="loading">
  {{>title "Loading..."}}
  <div class="centered-box">Loading...</div>
</template>

<template name="loadingNoMessage">
  {{!-- When switching between grains, we don't really want to show a "loading..." message until
  the grain's subscriptions are ready, since we've already loaded the iframe and the user can be
  interacting with it immediately.  But we also want to use waitOn for the topbar items.  So we
  set a loading template that is effectively empty string, and everything is great. --}}
</template>

<template name="notFound">
  {{>title "Not Found"}}
  <div class="centered-box">404 Not Found :(</div>
</template>

<template name="root">
  {{>title "Home"}}

  <div id="intro" class="{{#if splashUrl}}has-splash{{/if}}">
    {{#if needsAdminTokenLogin }}
      <p>
        This Sandstorm instance has no users. You should generate a token from the command line
        with `sandstorm admin-token` in order to access the admin settings page.
      </p>
    {{else}}
      {{> loginButtonsDialog globalAccountsUi}}
      {{#if splashUrl}}
        <iframe src="{{splashUrl}}"></iframe>
      {{/if}}
    {{/if}}
  </div>
</template>

<template name="grainTitle">
  <span class="editable" title="Rename" id="grainTitle" tabindex="0">{{title}}</span>
</template>
<template name="grainDeleteButton">
  <button class="grain-button" title="Delete" id="deleteGrain">Delete</button>
</template>
<template name="grainDebugLogButton">
  <button class="grain-button" title="Show Debug Log" id="openDebugLog">Log</button>
</template>
<template name="grainBackupButton">
  <button class="grain-button {{#if isLoading}}loading{{/if}}" title="Download Backup" id="backupGrain" disabled="{{#if isLoading}}true{{/if}}">Backup</button>
</template>
<template name="grainRestartButton">
  <button class="grain-button" title="Restart App" id="restartGrain">Restart</button>
</template>

<template name="grainApiTokenButton">
  <button class="show-popup" title="Get webkey">
    Get&nbsp;Webkey
  </button>
</template>

<template name="grainApiTokenPopup">
  <h4>Webkeys</h4>
  {{#if generatedApiToken}}
    {{#if generatedApiTokenPending}}
      <p>Generating...</p>
      <p><button id="resetApiToken">Cancel</button></p>
    {{else}}
      <p>Copy this webkey and give it to the external app:</p>
        <a id="apiTokenText" class="copy-me" href="{{generatedApiToken}}">{{generatedApiToken}}</a>
      {{#if currentUser}}
        <p><button id="resetApiToken">Go back</button></p>
      {{/if}}
    {{/if}}
  {{else}}
    <p>A webkey allows you to connect an external app (e.g. a mobile app) to this app.</p>
    <p><form class="newApiToken">
    Label: <input type="text" id="api-token-petname" placeholder="e.g. 'Android app'">
    {{#with viewInfo}}
      {{#if roles}}
        Role:
        <select id="api-token-role">
          <option title="has every app permission" selected=true>all access</option>
          {{#each roles}}
            <option title={{verbPhrase.defaultText}}
                    data-obsolete={{obsolete}}>
              {{title.defaultText}}</option>
          {{/each}}
        </select>
      {{/if}}
    {{/with}}
    <button>Create</button></form></p>
    {{#if existingTokens}}
      <p>Your existing webkeys:</p>
      <ul>
      {{#each existingTokens}}
        {{#if displayToken}}
          <li>
            <span class="token-petname" data-token-id="{{_id}}">
              {{petname}} ({{dateString created}})
            </span>
            <button class="revoke-token" title="Revoke" data-token-id="{{_id}}">Revoke</button>
          </li>
        {{/if}}
      {{/each}}
      </ul>
    {{/if}}
  {{/if}}
</template>

<template name="grainShareButton">
  <button class="show-popup" title="Share access to this grain">
    Share access
  </button>
</template>

<template name="whoHasAccess">
   <img src="/people.svg">
</template>
<template name="whoHasAccessPopup">
  <h4 class="who-has-access">Who has access</h4>
  <div class="tables-container">
    <h5>People</h5>
    {{#if transitiveShares.empty}}
      {{#if existingShareTokens}}
        <p>No logged-in users have visited your links yet.</p>
      {{else}}
        <p>You have granted access to nobody.</p>
      {{/if}}
    {{else}}
      <table class="people">
        {{#each transitiveShares}}
          <tr>
            <td> {{displayName recipient}} </td>
            <td> added by
              <ul>
                {{#each dedupedShares}}
                  <li>
                    {{displayName identityId}}
                    {{#if isCurrentIdentity identityId}}
                      <button class="revoke-access" title="Revoke" data-recipient="{{../recipient}}">
                        Revoke
                      </button>
                    {{/if}}
                  </li>
                {{/each}}
              </ul>
            </td>
          </tr>
        {{/each}}
      </table>
    {{/if}}
    {{#if existingShareTokens}}
      <h5>Sharing Links</h5>
      <table class="shared-links">
      {{!-- Renamed from sharing-links to shared-links due to a common adblock rule
            in https://easylist.adblockplus.org/fanboy-social.txt --}}
        {{#each existingShareTokens}}
          {{#if displayToken}}
            <tr>
              <td>
                <span class="token-petname" data-token-id="{{_id}}">
                  {{getPetname}} ({{dateString created}})
                </span>
              </td>
              <td>
                {{#if viewInfo.roles}}
                  <select class="share-token-role" data-token-id="{{_id}}">
                    {{#each indexedRoles}}
                      <option title={{title.defaultText}}
                              data-obsolete={{obsolete}}
                              selected={{hasCurrentRole ..}}>
                        {{roleText}}</option>
                    {{/each}}
                    {{#if hasCustomRole .}}
                      <option title="custom role" selected=true>
                        [has custom permissions]
                      </option>
                    {{/if}}
                  </select>
                {{/if}}
              </td>
              <td>
                <button class="revoke-token" title="Revoke" data-token-id="{{_id}}">Revoke</button>
              </td>
            </tr>
          {{/if}}
        {{/each}}
      </table>
      {{/if}}
   </div>
</template>

<template name="selectRole">
  {{#with viewInfo}}
  {{#if roles}}
  <select class="share-token-role" title="select a role">
    {{#each roles}}
    <option title={{title.defaultText}}
            data-obsolete={{obsolete}}
            {{!-- We need this special attributed because apparently Meteor does not play nice
                  with HTMLOptionElement.defaultSelected. --}}
            data-default-selected={{default}}
            selected={{default}}>
      {{roleText}}</option>
    {{/each}}
  </select>
  {{/if}}
  {{/with}}
</template>

<template name="emailInviteTab">
  <form class="email-invite">
    <p>
    <span class="icon icon-people"></span>
    {{> contactInputBox contacts=contacts preselectedIdentityId=preselectedIdentityId}}
    {{> selectRole viewInfo=viewInfo}}
    </p>
    <div>
      <textarea class="personal-message"
                placeholder="Type a personal message (optional)..."></textarea>
    </div>
    {{#if completionState.clear}}
    <div class="button-container" role="presentation">
      <button>Send</button>
    </div>
    {{/if}}
  </form>
  {{#with completionState}}
    {{#if success}}
     <p>Successfully sent.</p>
     <p><button class="reset-invite">+ Send more invites</button></p>
    {{/if}}
    {{#if pending}}
      <p>Sending...</p>
    {{/if}}
    {{#if error}}
      <p> {{error}} </p>
      <p><button class="start-over-invite">&lt;&lt; Start over</button></p>
    {{/if}}
  {{/with}}
</template>

<template name="shareableLinkTab">
  <form class="new-share-token">
    <p>
      <span class="icon icon-people"></span>
      Anyone with this link{{#if viewInfo.roles}}:{{else}} can access the grain.{{/if}}
      {{> selectRole viewInfo=viewInfo}}
    </p>
    <input type="text" class="label" placeholder="Label (optional)">
    <p class="label-explanation">
      Use a label to remind yourself to whom you sent this unique link.</p>
    {{#if completionState.clear}}
      <div class="button-container">
        <button>Create</button>
      </div>
    {{/if}}
  </form>
  {{#with completionState}}
    {{#if success}}
      <p><span class="icon icon-copy"></span> Copy this link:</p>
      <a id="share-token-text" class="copy-me" href="{{success.url}}">{{success.url}}</a>
      <p><button class="reset-share-token">+ Create another link</button></p>
    {{/if}}
    {{#if pending}}
      <p>Generating...</p>
      <p><button class="reset-share-token">Cancel</button></p>
    {{/if}}
  {{/with}}
</template>

<template name="shareWithOthers">
  <h4 class="share-with-others">Share with others</h4>
  {{#if grain.isOldSharingModel}}
    <p>This grain uses the old sharing model. You can share it by copy/pasting the URL from the
       location bar.</p>
    {{#if grain.isOwner}}
      <p>You can upgrade this grain to the new model, but anyone with whom you shared this grain
         previously will lose access; you will have to share it with them again.</p>
      <p>Upgrading cannot be undone.</p>
      <p><button id="privatize-grain">upgrade</button></p>
    {{/if}}
  {{else}}
  <div class="share-tabs" role="presentation">
    <ul role="tablist">
      <li id="send-invite-tab-header" tabindex="0" role="tab" aria-controls="send-invite-tab" aria-selected="true"> Send an invite </li>
      <li id="shareable-link-tab-header" tabindex="-1" role="tab" aria-controls="shareable-link-tab" aria-selected="false"> Get shareable link </li>
    </ul>
    <div id="send-invite-tab" role="tabpanel" class="tabpanel" aria-labelledby="send-invite-tab-header" aria-hidden="false">
      {{> emailInviteTab viewInfo=grain.viewInfo title=grain.title grainId=grain.grainId }}
    </div>
    <div id="shareable-link-tab" role="tabpanel" class="tabpanel" aria-labelledby="shareable-link-tab-header" aria-hidden="true">
      {{> shareableLinkTab viewInfo=grain.viewInfo }}
    </div>
  </div>

  <div class="footer">
    <span class="icon icon-people"></span>
    <button class="who-has-access">See who has access</button>
  </div>
  {{/if}}
</template>

<template name="grainSharePopup">
  {{#if incognito}}
    <p>
      You are viewing this grain anonymously.
    </p>
    <p>
      To share access, copy this link:
      {{#with currentTokenUrl}}
        <a id="share-token-text" class="copy-me" href="{{.}}">{{.}}</a>
      {{/with}}
    </p>
    <p>
      {{#if currentUser}}
        For more sharing options, you must
        <a class="open-non-anonymously" href="{{currentTokenUrl}}">
          open this grain non-anonymously
        </a>.
      {{else}}
        For more sharing options, please sign in.
      {{/if}}
    </p>
  {{else}}
    {{> shareWithOthers grain=currentGrain}}
  {{/if}}
</template>

<template name="grainPowerboxRequest">
  <button class="show-popup" title="Powerbox request">
    P
  </button>
</template>
<template name="grainPowerboxRequestPopup">
  {{>powerboxRequest . }}
</template>

<template name="grainPowerboxOffer">
  <button class="show-popup" title="Powerbox offer">
    P
  </button>
</template>
<template name="grainPowerboxOfferPopup">
  <h4>Powerbox Offer</h4>
  <div>
    <a class="copy-me" href="{{powerboxOfferUrl}}" id="powerbox-offer-url">{{powerboxOfferUrl}}</a>
    <button class="dismiss">Dismiss</button>
  </div>
</template>

<template name="grain">
  {{>sandstormTopbarItem name="title" priority=5 topbar=globalTopbar template="grainTitle"}}
  {{#sandstormTopbarItem name="grain-size" priority=5 topbar=globalTopbar}}
    {{grainSize}}
  {{/sandstormTopbarItem}}

  {{>sandstormTopbarBlockReload}}

  {{setGrainWindowTitle}}

  {{>sandstormTopbarItem name="share" topbar=globalTopbar template="grainShareButton"
      popupTemplate="grainSharePopup"}}
  {{#if currentUser}}
    {{>sandstormTopbarItem name="delete" topbar=globalTopbar template="grainDeleteButton"}}
  {{/if}}
  {{#if isOwner}}
    {{>sandstormTopbarItem name="debug-log" topbar=globalTopbar template="grainDebugLogButton" data=globalTopbar}}
    {{>sandstormTopbarItem name="backup" topbar=globalTopbar template="grainBackupButton" data=globalTopbar}}
    {{>sandstormTopbarItem name="restart" topbar=globalTopbar template="grainRestartButton" data=globalTopbar}}
  {{/if}}
  {{#if displayWebkeyButton}}
    {{>sandstormTopbarItem name="webkey" topbar=globalTopbar
        template="grainApiTokenButton" popupTemplate="grainApiTokenPopup"}}
  {{/if}}
  {{#if showPowerboxRequest}}
  {{>sandstormTopbarItem name="request" topbar=globalTopbar template="grainPowerboxRequest"
        startOpen=true popupTemplate="grainPowerboxRequestPopup" data=powerboxRequestData
        onDismiss=cancelPowerboxRequest}}
  {{/if}}
  {{#if showPowerboxOffer}}
    {{>sandstormTopbarItem name="offer" topbar=globalTopbar template="grainPowerboxOffer"
        startOpen=true popupTemplate="grainPowerboxOfferPopup" data=powerboxOfferData}}
  {{/if}}
</template>

<template name="share">
  {{#if currentUser}}
    {{#with grainNotFound}}
      No grain found with ID {{.}}. Maybe you need to sign in to a different account?
    {{/with}}
  {{else}}
    You must be signed in to grant access to a grain.
  {{/if}}
</template>

<template name="apps">
  {{> sandstormAppListPage . }}
</template>

<template name="grains">
  {{> sandstormGrainListPage . }}
</template>

<template name="appDetails">
  {{> sandstormAppDetailsPage . }}
</template>

<template name="_grainSpinner">
  {{!-- This is a terrible hack to center this thing. The styles shold go in css, but it's
    arguably more confusing to put them there when all they're doing is this archaic pattern to
    get a horizontally+vertically centered div --}}
  <div id="grain-loading-spinner">
    <div style="display:table-cell;vertical-align:middle;">
      <div style="margin-left:auto;margin-right:auto;text-align:center;">
        <img src="/spinner_96.gif" alt="loading">
      </div>
    </div>
  </div>
</template>

<template name="grainLog">
  <div class="grainlog-title">Debug log: {{title}}</div>
  <div class="grainlog-contents" aria-live="polite">
    <pre>...{{{html}}}</pre>
  </div>
</template>

<template name="install">
  {{> sandstormAppInstallPage . }}
</template>

<template name="account">
  <div class="account">
    {{#if .}}
      {{>sandstormAccountSettings .}}
    {{/if}}
  </div>
</template>

<template name="accountUsage">
  {{> billingUsage db=globalDb}}
  {{> billingSettings db=globalDb}}
</template>

<template name="signup">
  {{>title "Claim Invite"}}

  <div class="centered-box">
  {{#if alreadySignedUp}}
    {{#if keyIsUsed}}
      <p>You're all signed up!  Now go <a href="https://apps.sandstorm.io/?host={{origin}}">install
        some apps</a>.</p>
    {{else}}
      <p>It looks like you already have an account, so you don't need this signup key.</p>
    {{/if}}
  {{else}}
    {{#if keyIsValid}}
      {{#if keyIsUsed}}
        <p>Sorry, this signup key has already been used.</p>
      {{else}}
        {{#if currentUser}}
          <p>Please wait...</p>
        {{else}}
          <p>{{signupDialog}} First, you have to sign in. Click "Sign in" in the upper-right.</p>
          <div id="sign-in-arrow"></div>
        {{/if}}
      {{/if}}
    {{else}}
      <p>Sorry, this is not a valid signup key.</p>
    {{/if}}
  {{/if}}
  </div>
</template>

<template name="adminInvites">
  {{setDocumentTitle}}
  <div id="invite">
    {{#if error}}
      <p>{{error}}</p>
      <p><button id="retry">Try Again</button></p>
    {{else}}{{#if url}}
      <p>New key: <input type="text" class="autoSelect" value="{{url}}" readonly></p>
      <p>Send this key to someone to allow them to create an account on your server.</p>
      <p><button id="retry">Create Another</button></p>
    {{else}}{{#if sent}}
      <p>Sent!</p>
      <p><button id="retry">Send more</button></p>
    {{else}}
      <p>You can invite friends to create accounts on your server. People you invite will be
        able to install apps and create grains of their own. You do NOT need to invite someone
        if you just want to share your grains with them.</p>
      <h3>Create a link:</h3>
      <p>This will create a magic link which you can send to someone.</p>
      <p>
        {{#if quotaEnabled}}
          Quota: <input id="key-quota" type="text" placeholder="(bytes; blank for none)"><br>
        {{/if}}
        <input id="key-note" type="text" placeholder="notes, e.g. name of the recipient">
        <button id="create">Create</button></p>

      <h3>Send an e-mail:</h3>
      <p>This will create a link and send it in an e-mail. <code>$KEY</code> will be replaced
        with the newly-generated link.</p>
      <div style="text-align: right; margin-top: 1em;">
        <p>From: <input type="text" id="invite-from" placeholder="me@example.com" value="{{email}}"></p>
        <p>To:
        <textarea id="invite-emails" placeholder="E-mail addresses, one per line."></textarea></p>
        <p>Subject: <input type="text" id="invite-subject" value="Join my Sandstorm server!"></p>
        <p>Body:
        <textarea id="invite-message">Click on the following link to get access to my Sandstorm.io server.

  $KEY</textarea></p>
        {{#if quotaEnabled}}
          <p>Quota: <input id="invite-quota" type="text" placeholder="(bytes; blank for none)"></p>
        {{/if}}
        <p><button id="send">Send</button></p>
      </div>

      {{#if quotaEnabled}}
        <h3>Update quotas:</h3>
        <p>You can batch modify existing users' quotas by specifying the e-mail address under which they were invited. This only works for user who were invited using the "Send an e-mail" form, above.</p>
        <div style="text-align: right; margin-top: 1em;">
          <p>Emails:
          <textarea id="set-quota-emails" placeholder="E-mail addresses, one per line."></textarea></p>
          <p>Quota: <input id="set-quota-quota" type="text" placeholder="(bytes; blank for none)"></p>
          <p><button id="set-quota-submit">Update</button></p>
        </div>
      {{/if}}
    {{/if}}
    {{/if}}
    {{/if}}
  </div>
</template>

<template name="adminLog">
  {{setDocumentTitle}}
  <div id="adminLog">
    <pre>...{{{html}}}</pre>
  </div>
</template>

<template name="uploadStatus">
  {{>title "Uploading..."}}

  <div id="restoreGrain" class="centered-box">
  {{#if error}}
    <p>Upload failed: {{error.status}} {{error.statusText}}</p>
    <pre>{{error.response}}</pre>
  {{else}}
    {{#if status}}
      <p>{{status}}... {{#if progress}}{{progress}}%{{/if}}</p>
    {{else}}
      <p>Upload failed. Please try again.</p>
    {{/if}}
  {{/if}}
  </div>
</template>

<template name="_adminConfigureLoginServiceDialog">
  {{#if visible}}
    <div id="configure-login-service-dialog" class="accounts-dialog accounts-centered-dialog">
      {{> configurationSteps}}

      <p>
        Now, copy over some details.
      </p>
      <p>
        <table>
          <colgroup>
            <col span="1" class="configuration_labels">
            <col span="1" class="configuration_inputs">
          </colgroup>
          {{#each configurationFields}}
            <tr>
              <td>
                <label for="configure-login-service-dialog-{{property}}">{{label}}</label>
              </td>
              <td>
                <input id="configure-login-service-dialog-{{property}}" type="text" value="{{value}}">
              </td>
            </tr>
          {{/each}}
        </table>
      </p>
      <div class="new-section">
        <div class="login-button configure-login-service-dismiss-button">
          Cancel
        </div>
        <a class="accounts-close configure-login-service-dismiss-button">&times;</a>

        <div class="login-button login-button-configure"
             id="configure-login-service-dialog-save-configuration">
          Save Configuration
        </div>
      </div>
    </div>
  {{/if}}
</template>

<template name="admin">
  {{>title "Admin Settings"}}

  {{#if wildcardHostSeemsBroken}}
  <div class="wildcard-host-warning">
    WARNING: This server seems to have its WILDCARD_HOST misconfigured.  Until you fix it, you will
    not be able to use any apps.
    <a target="_blank"
       href="https://docs.sandstorm.io/en/latest/administering/faq/#why-do-i-see-an-error-when-i-try-to-launch-an-app-even-when-the-sandstorm-interface-works-fine">
      Learn more.</a>  You'll need to adjust DNS, SSL/TLS certificates, or edit the sandstorm.conf
    file. Once you have addressed the issue, reload this page. If you're still having problems,
    <a href="https://github.com/sandstorm-io/sandstorm/issues">please file an issue.</a>
  </div>
  {{/if}}

  {{#if websocketSeemsBroken}}
  <div class="websocket-broken-warning">
    WARNING: This server seems to be unable to create a WebSocket. Sandstorm may appear to run fine,
    but many apps will fail to run properly.
    <a target="_blank"
       href="https://docs.sandstorm.io/en/latest/administering/faq/#how-do-i-enable-websockets-proxying-or-why-do-some-apps-seem-to-crash-reload">
      Learn more.</a>  Usually this is caused by a reverse proxy like nginx or Apache that needs to
      be reconfigured. If you think you are seeing this message in error, please reload this page or
    <a href="https://github.com/sandstorm-io/sandstorm/issues">file an issue.</a>
  </div>
  {{/if}}

  {{> _adminConfigureLoginServiceDialog}}
  <div id="admin-settings" class="centered-box">
    {{#if isUserPermitted}}
      <ul class="nav centered-box settings-tabs">
        <li id="settings-tab" class="{{#if settingsActive}}active{{/if}}">
          {{#linkTo route="adminSettings" data=getToken}}Settings{{/linkTo}}
        </li>
        <li id="users-tab" class="{{#if usersActive}}active{{/if}}">
          {{#linkTo route="adminUsers" data=getToken}}Users{{/linkTo}}
        </li>
        <li id="stats-tab" class="{{#if statsActive}}active{{/if}}">
          {{#linkTo route="adminStats" data=getToken}}Stats{{/linkTo}}
        </li>
        <li id="log-tab" class="{{#if logActive}}active{{/if}}">
          {{#linkTo route="adminLog" data=getToken}}Log{{/linkTo}}
        </li>
        <li id="invites-tab" class="{{#if invitesActive}}active{{/if}}">
          {{#linkTo route="adminInvites" data=getToken}}Send Invite{{/linkTo}}
        </li>
        <li id="caps-tab" class="{{#if capsActive}}active{{/if}}">
          {{#linkTo route="adminCaps" data=getToken}}Capabilities{{/linkTo}}
        </li>
        <li id="advanced-tab" class="{{#if advancedActive}}active{{/if}}">
          {{#linkTo route="adminAdvanced" data=getToken}}Advanced{{/linkTo}}
        </li>
        <li id="featurekey-tab" class="{{#if featureKeyActive}}active{{/if}}">
          {{#linkTo route="adminFeatureKey" data=getToken}}For Work{{/linkTo}}
        </li>
      </ul>
      {{> Template.dynamic template=adminTab}}
      {{#if success}}
      <div class="alert alert-success {{#if fadeAlert}}fade-out{{/if}}"><strong>Success!</strong> {{successMessage}}</div>
      {{/if}}
      {{#if failure}}
      <div class="alert alert-danger {{#if fadeAlert}}fade-out{{/if}}"><strong>Failure!</strong>
        <ul>
          {{#each errors}}
          <li>{{reason}}</li>
          {{/each}}
        </ul>
        For internal server errors, see {{#linkTo route='adminLog' data=getToken}}the Sandstorm server log{{/linkTo}} for details.
      </div>
      {{/if}}
    {{else}}
      <p>
        You are not logged in as admin and there isn't a valid token specified. You should
        either log in as an admin user or generate a token from the command line by doing
        `sandstorm admin-token` in order to access the admin settings page.
      </p>
    {{/if}}
  </div>
</template>

<template name="adminSettings">
  {{setDocumentTitle}}
  <form id="admin-settings-form" autocomplete="off">
    <h4>Basic login providers</h4>

    <p>Choose which services users may use to identify themselves. Anyone can log in, but only users you {{#linkTo route="adminInvites" data=getToken}}invite{{/linkTo}} will be able to install apps or create files.</p>

    <p class="login-providers">
      <label><input type="checkbox" class="oauth-checkbox" name="googleLogin"
                    value="value" checked={{googleSetting.value}} data-servicename="google">
        Enable Google Login
        (<a class="configure-oauth" data-servicename="google" href="">configure</a>)
        (<a class="reset-login-tokens" data-servicename="google" href="">log out all users</a>)
      </label>

      {{#with googleSetting.automaticallyReset}}
        <p class="alert-danger reset-reason">
          Google login was automatically disabled
          {{#with baseUrlChangedFrom}}
            because this server's BASE_URL has been updated. Its old value was {{.}}.
          {{else}}
            for an unknown reason.
          {{/with}}
          Please make sure the configuration is correct before re-enabling.
          You will likely need to update the OAuth redirect URL in the Google Developer Console.
        </p>
      {{/with}}
      <label><input type="checkbox" class="oauth-checkbox" name="githubLogin"
                    value="value" checked={{githubSetting.value}} data-servicename="github">
        Enable Github Login
        (<a class="configure-oauth" data-servicename="github" href="">configure</a>)
        (<a class="reset-login-tokens" data-servicename="github" href="">log out all users</a>)
      </label>
      {{#with githubSetting.automaticallyReset}}
        <p class="alert-danger reset-reason">
          GitHub login was automatically disabled
          {{#with baseUrlChangedFrom}}
            because this server's BASE_URL has been updated. Its old value was {{.}}.
          {{else}}
            for an unknown reason.
          {{/with}}
          Please make sure the configuration is correct before re-enabling.
          You will likely need to update the OAuth redirect URL in GitHub application settings.
        </p>
      {{/with}}
      <label><input type="checkbox" name="emailTokenLogin" value="value" checked={{emailTokenEnabled}}> Enable Passwordless Email Login</label>
    </p>
    {{#if isFeatureKeyValid}}
      <h4>LDAP login</h4>
      <p class="forwork-note">Sandstorm for Work feature</p>

      <p><label>
        <input type="checkbox" name="ldapLogin" value="value" checked={{ldapEnabled}}> Enable LDAP Login
      </label><br>
        <label>LDAP Url: <input id="ldapUrl" type="text" name="ldapUrl" value="{{ldapUrl}}"></label>

        <label>LDAP Base Search Dn: <input id="ldapBase" type="text" name="ldapBase" value="{{ldapBase}}"></label>
        <label>LDAP Search Username Field: <input id="ldapSearchUsername" type="text" name="ldapSearchUsername" value="{{ldapSearchUsername}}"></label>
        <label>LDAP Search Bind Dn: (optional, needed if your server doesn't allow unauthenticated searches): <input type="text" name="ldapSearchBindDn" value="{{ldapSearchBindDn}}" placeholder="eg. uid=admin,OU=Users,DC=example,DC=com"></label>
        <label>LDAP Search Bind Password: (optional, needed if specifying bind Dn above): <input type="password" name="ldapSearchBindPassword" value="{{ldapSearchBindPassword}}" ></label>
        <label>LDAP Search Filter (optional, see <a href="http://www.ietf.org/rfc/rfc2254.txt">RFC2254</a>): <input id="ldapFilter" type="text" name="ldapFilter" value="{{ldapFilter}}" placeholder="eg. (&(email=*@bar.com)(!(ou=students))"></label>

        <label>LDAP Given Name Field: <input id="ldapNameField" type="text" name="ldapNameField" value="{{ldapNameField}}"></label>
        <label>LDAP Email Field: <input id="ldapEmailField" type="text" name="ldapEmailField" value="{{ldapEmailField}}"></label>
      </p>

      <h4>SAML login</h4>
      <p class="forwork-note">Sandstorm for Work feature</p>

      <p>Your SAML IDP should be configured to return a persistent nameID. In addition you <b>*must*</b> configure your IDP to provide two extra attributes, "email" and "displayName". If your SAML provider asks for the single sign on url of this service provider, then supply it with "{{rootUrl}}/_saml/validate/default".</p><br>

      <label>
        <input type="checkbox" name="samlLogin" value="value" checked={{samlEnabled}}> Enable SAML Login
      </label><br>
      <label>SAML provider entry point URL: <input type="text" name="samlEntryPoint" value="{{samlEntryPoint}}" placeholder="(eg. https://YOUR_SAML_PROVIDER.com/sso/saml)"></label>
      <label>SAML cert for above provider: <textarea name="samlPublicCert" value="{{samlPublicCert}}" placeholder="base64 encoded cert (eg. MIID...8F==)" rows="4"></textarea></label>
      <!-- TODO(someday): allow a private cert to be provided for signing messages in the other direction (or autogenerate one and provide admins the public cert here?) -->

      <h4>Define organization</h4>
      <p class="forwork-note">Sandstorm for Work feature</p>

      <p>These users will be considered part of your organization. They will automatically be
        able to log in, install apps, and create grains.</p>

      <p>
        <label><input type="checkbox" name="isOrganizationLdap" value="value" checked={{isOrganizationLdap}}> Users authenticated via LDAP.</label><br>
        <label><input type="checkbox" name="isOrganizationSaml" value="value" checked={{isOrganizationSaml}}> Users authenticated via SAML.</label><br>
        <label><input type="checkbox" name="isOrganizationGoogle" value="value" checked={{isOrganizationGoogle}}> Users authenticated via Google Apps for Work domain:</label> <input type="text" name="organizationGoogle" value="{{organizationGoogle}}" placeholder="example.com">
        <label><input type="checkbox" name="isOrganizationEmail" value="value" checked={{isOrganizationEmail}}>Users authenticated via passwordless email login with addresses at domain:</label> <input type="text" name="organizationEmail" value="{{organizationEmail}}" placeholder="example.com"></p>
    {{else}}
      <p>To get support for LDAP, SAML, and organization management, enable
        <a href="{{featuresPath}}">Sandstorm for Work</a>.</p>
    {{/if}}
    <div class="legacy-email-config">
      <h4>SMTP Configuration: <button id="admin-settings-send-toggle">Test</button></h4>
      {{#if isEmailTestActive}}
        <label>
          Send test email to: <input id="email-test-to" type="text">
        </label>
        <button id="admin-settings-send-test">Send</button>
      {{/if}}

      {{#let smtp=smtpConfig}}
      <label>Relay hostname:
        <input type="text" name="smtpHostname" value="{{smtp.hostname}}" />
      </label>
      <span class="details">The address of the SMTP relay server to be used to send email login
          messages, sharing links,
          {{#linkTo route="adminInvites" data=getToken}}invitations{{/linkTo}},
          and other notification emails.
          The SMTP server should be configured to allow sending email from your Sandstorm domain and
          from email addresses that will be used to send invites. Read the
          <a href="https://docs.sandstorm.io/en/latest/administering/email/#outgoing-smtp">docs</a>
          for more details.
      </span>

      <label>Relay port:
        <input type="number" name="smtpPort" value="{{smtp.port}}"/>
      </label>
      <span class="details">SMTP (unencrypted or with StartTLS) uses port 25, TLS-encrypted SMTPS
          uses port 465.</span>

      <label>Username:
        <input type="text" name="smtpUsername" value="{{smtp.auth.user}}" />
      </label>
      <span class="details">Optional.  Use if your email relay requires authentication.</span>

      <label>Password:
        <input type="password" name="smtpPassword" value="{{smtp.auth.pass}}" />
      </label>
      <span class="details">Optional.  Use if your email relay requires authentication.</span>

      <label>Return Address:
        <input type="email" name="smtpReturnAddress" value="{{smtp.returnAddress}}">
      </label>
      <span class="details">E-mail address to place in the "From" header of email notifications from this server. You can specify a "no-reply" address, but we suggest using an address that users can mail if they need help.</span>
      {{/let}}
    </div>
    <p><button id="admin-settings-save">Save</button></p>
  </form>
</template>

<template name="adminUsers">
  {{setDocumentTitle}}

  {{#if Template.subscriptionsReady}}
  <table class="admin-table">
    <thead>
      <tr>
        <td>Service</td>
        <td>Handle</td>
        <td>Name</td>
        <td>User Class</td>
        {{#if quotaEnabled}}
          <td>Plan</td>
          <td>Used</td>
        {{/if}}
        <td>Created</td>
        <td>Last Active</td>
        <td>Invited as</td>
      </tr>
    </thead>
    <tbody>
      {{#each users}}
        <tr>
          {{#with userIdentity}}
            <td>{{profile.service}}</td>
            <td>{{profile.handle}}</td>
            <td>{{profile.name}}</td>
          {{/with}}
          <td>
            <select class="user-class" name="select">
              <option value="admin" selected={{#if userIsAdmin}}selected{{/if}}>Admin</option>
              <option value="invited" selected={{#if userIsInvited}}selected{{/if}}>Invited User</option>
              <option value="guest" selected={{#if userIsGuest}}selected{{/if}}>Guest</option>
            </select>
          </td>
          {{#if quotaEnabled}}
            <td>{{plan}}</td>
            <td>{{userStorageUsage}}</td>
          {{/if}}
          <td title="{{createdAt}}">{{dateString createdAt}}</td>
          <td title="{{lastActive}}">{{dateString lastActive}}</td>
          <td>{{userSignupNote}}</td>
        </tr>
      {{/each}}
    </tbody>
  </table>
  {{/if}}
</template>

<template name="adminStats">
  {{setDocumentTitle}}
  <div id="stats">
    {{#if reportStatsFirstVisit}}
      <div class="report-stats-yesno-box">
        <p>We'd like to know how many Sandstorm users there are, to make graphs and such. Is it OK to send the numbers on this page to Sandstorm, so that we can add them to the totals? Any stats you send are anonymous.</p>
        <button class="yes">Send anonymous stats</button>
        <button class="no">Don't send</button>
      </div>
    {{else}}
      <label class="report-stats">
        <input class="enableStatsCollection" type="checkbox" name="reportStats" checked={{reportStats}}>
        Anonymously share the stats below with Sandstorm.io.
        {{#if reportStatsSaving}}
          {{#if reportStatsSaved}}
          <span class="check-mark {{#if fadeCheckmark}}fade-out{{/if}}" title="saved">âœ“</span>
          {{else}}
          <img src="/spinner_96.gif" alt="loading">
          {{/if}}
        {{/if}}
      </label>
    {{/if}}
    <p>Right now: {{current.activeUsers}} users, {{current.activeGrains}} grains</p>
    <p>Today: {{today.activeUsers}} users, {{today.activeGrains}} grains</p>

    <p>Previous days:</p>

    <table>
      <tr>
        <td rowspan="2">date</td>
        <td colspan="4">users</td>
        <td colspan="4">grains</td>
      </tr>
      <tr>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
        <td>forever</td>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
        <td>forever</td>
      </tr>
      {{#each points}}
        <tr>
          <td>{{day}}</td>
          <td>{{daily.activeUsers}}</td>
          <td>{{weekly.activeUsers}}</td>
          <td>{{monthly.activeUsers}}</td>
          <td>{{forever.activeUsers}}</td>
          <td>{{daily.activeGrains}}</td>
          <td>{{weekly.activeGrains}}</td>
          <td>{{monthly.activeGrains}}</td>
          <td>{{forever.activeGrains}}</td>
        </tr>
      {{else}}
        <tr>
          <td colspan="7">There are no stats yet, or you are not admin.</td>
        </tr>
      {{/each}}
    </table>


    <h3 id="app-stats">Apps</h3>

    <span>Select a date:</span>
    <select class="package-date">
      {{#each appDates}}
        <option value="{{_id}}" selected="{{#if selected}}true{{/if}}">{{day}}</option>
      {{/each}}
    </select>
    <table class="apps">
      <tr>
        <td rowspan="2">App Name</td>
        <td colspan="4">owners</td>
        <td colspan="4">sharedUsers</td>
        <td colspan="4">grains</td>
      </tr>
      <tr>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
        <td>forever</td>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
        <td>forever</td>
        <td>daily</td>
        <td>weekly</td>
        <td>monthly</td>
        <td>forever</td>
      </tr>
      {{#each apps}}
        <tr>
          <td title="{{appId}}">{{appTitle}}</td>
          <td>{{daily.owners}}</td>
          <td>{{weekly.owners}}</td>
          <td>{{monthly.owners}}</td>
          <td>{{forever.owners}}</td>
          <td>{{daily.sharedUsers}}</td>
          <td>{{weekly.sharedUsers}}</td>
          <td>{{monthly.sharedUsers}}</td>
          <td>{{forever.sharedUsers}}</td>
          <td>{{daily.grains}}</td>
          <td>{{weekly.grains}}</td>
          <td>{{monthly.grains}}</td>
          <td>{{forever.grains}}</td>
        </tr>
      {{else}}
        <tr>
          <td colspan="7">There are no stats yet, or you are not admin.</td>
        </tr>
      {{/each}}
    </table>
    <h3>API token</h3>
    <button id="regenerateStatsToken">Regenerate Token</button>
    <span><a href="/fetchStats/{{token._id}}">{{token._id}}</a></span>
  </div>
</template>

<template name="adminCaps">
  {{setDocumentTitle}}
  {{#if showPowerboxOffer}}
    {{>sandstormTopbarItem name="offer" topbar=globalTopbar template="grainPowerboxOffer"
        startOpen=true popupTemplate="grainPowerboxOfferPopup" data=powerboxOfferData}}
  {{/if}}
  <p><button id="offer-ipnetwork">Offer IpNetwork Capability</button>
     <button id="offer-ipinterface">Offer IpInterface Capability</button><br>
    <span class="details">These buttons create webkeys (special secret addresses) representing permission to directly access the network. IpNetwork represents the capability to make outbound requests to the network. IpInterface represents the capability to receive inbound connections on the machine's main network interface. Some apps -- especially drivers -- will ask for these permissions. To grant them, you'll need to copy/paste the webkey from here into the app's request box. (Eventually, this UI will be superseded by the Powerbox picker.)</span></p>
  <hr>
  <table class="admin-table">
    <thead>
      <tr>
        <td>Type</td>
        <td>User</td>
        <td>Created</td>
      </tr>
    </thead>
    <tbody>
      {{#each caps}}
        <tr class="{{#if disabled}}revoked-cap{{/if}}">
          <td>{{#if frontendRef.ipNetwork}}IpNetwork{{/if}}{{#if frontendRef.ipInterface}}IpInterface{{/if}}</td>
          <td>{{userName}}</td>
          <td title="{{created}}">{{dateString created}}</td>
          <td><a class="disable-cap" data-id="{{_id}}">x</a></td>
        </tr>
      {{/each}}
    </tbody>
  </table>
</template>

<template name="adminAdvanced">
  {{setDocumentTitle}}
  <form id="admin-settings-form" autocomplete="off">
    <p>Server Title: <input type="text" name="serverTitle" value="{{serverTitle}}"><br>
      <span class="details">The name of this server, for use when communicating with users. Example: "Bob's Sandstorm Server"</span></p>
    <p>Splash URL: <input type="text" name="splashUrl" value="{{splashUrl}}" placeholder="https://example.com"><br>
      <span class="details">This web page will be displayed in the background behind the login dialog (the home page when logged out). For security reasons, the page must be hosted within this Sandstorm server's wildcard host (otherwise it will be blocked by <code>Content-Security-Policy</code>). We suggest using a static web publishing app like <a href="https://apps.sandstorm.io/app/nqmcqs9spcdpmqyuxemf0tsgwn8awfvswc58wgk375g4u25xv6yh?host={{origin}}" target="_blank">Hacker CMS</a> to host the content. <strong>WARNING: This feature is experimental; in particular the style and positioning of the login box is subject to change without notice.</strong> Please <a href="https://github.com/sandstorm-io/sandstorm/issues" target="_blank">let us know</a> if you'd like to see it stabilize.</span></p>
    <p>Signup Dialog: <input type="text" name="signupDialog" value="{{signupDialog}}"><br>
      <span class="details">This text will be displayed to users who click on signup links.</span></p>
    <p>Terms of Service URL: <input type="text" name="termsUrl" value="{{termsUrl}}"><br>
       Privacy Policy URL: <input type="text" name="privacyUrl" value="{{privacyUrl}}"><br>
      <span class="details">If provided, new users will be required to agree to these.</span></p>
    <p>Admin Alert: <input type="text" name="adminAlert" value="{{adminAlert}}"><br>
       Alert Time (e.g. "5/9/2022 6:00 PM"): <input id="alertTime" type="text" name="alertTime" value="{{alertTime}}"><br>
       Alert URL (optional): <input id="alertUrl" type="text" name="alertUrl" value="{{alertUrl}}"><br>
      <span class="details">
        This will be shown to all users in the topbar, on the right. If the alert text is
        empty, no alert will be displayed. You can use the following variables that will be replaced
        automatically:
        <ul>
          <li>$TIME : The time component of Alert Time, converted to the user's local time (eg. "1:15:45 PM")</li>
          <li>$DATE : The date component of Alert Time, converted to the user's local time (eg. "6/19/2015")</li>
          <li>$IN_COUNTDOWN : An active countdown until Alert Time (eg. "in 3 days" or "in 1 minute"). Displays "any moment" at the alert time and then disappears after an hour. Useful for announcing scheduled maintenance.</li>
          <li>$ACCOUNT_EXPIRES : The time when the viewer's demo account expires (this is only useful for demo servers)</li>
          <li>$ACCOUNT_EXPIRES_IN : An active countdown until the viewer's demo account is deleted (this is only useful for demo servers)</li>
          <li>$APPNAME : The name of the current app (this variable also works for "Alert URL").</li>
        </ul>
      </span>
    </p>
    <p>App Market URL: <input type="text" name="appMarketUrl" value="{{appMarketUrl}}"><br>
       App Index URL: <input type="text" name="appIndexUrl" value="{{appIndexUrl}}"><br>
       <label><input type="checkbox" name="appUpdatesEnabled" checked={{appUpdatesEnabled}}> App Update Notifications Enabled</label><br>
      <span class="details">Updates to apps will be automatically downloaded by the Sandstorm server daily and notifications sent to users asking if they want to update their installed apps.</span></p>
    <p><button id="admin-settings-save">Save</button></p>
  </form>
</template>

<template name="adminFeatureKey">
  {{setDocumentTitle}}

  {{#if currentFeatureKey}}
    <h4>Current feature key</h4>
    {{#with featureKey=currentFeatureKey}}
    <div class="feature-key-data">
      <div class="feature-key-properties">
        <div class="feature-key-property-row">
          <span class="feature-key-property-key">Plan</span>
          <span class="feature-key-property-value">{{featureKey.userLimit}} users
            {{#if featureKey.isTrial}}<span class="feature-key-label feature-key-trial">Trial</span>{{/if}}
            {{#with validity=(computeValidity featureKey)}}
              <span class="feature-key-label feature-key-{{validity.className}}">{{validity.labelText}}</span>
            {{/with}}
          </span>
        </div>
        <div class="feature-key-property-row">
          <span class="feature-key-property-key">Issued</span>
          <span class="feature-key-property-value">{{renderDateString featureKey.issued}}</span>
        </div>
        <div class="feature-key-property-row">
          <span class="feature-key-property-key">Expires</span>
          <span class="feature-key-property-value">{{renderDateString featureKey.expires}}</span>
        </div>
      </div>
      <div class="feature-key-org-info">
        {{#with customer=featureKey.customer}}
        <div class="feature-key-property-row">
          <span class="feature-key-property-key">Organization Name</span>
          <span class="feature-key-property-value">{{customer.organizationName}}</span>
        </div>
        <div class="feature-key-property-row">
          <span class="feature-key-property-key">Organization ID</span>
          <span class="feature-key-property-value">{{customer.id}}</span>
        </div>
        <div class="feature-key-property-row">
          <span class="feature-key-property-key">Organization Contact</span>
          <span class="feature-key-property-value">{{customer.contactName}} &lt;{{customer.contactEmail}}&gt;</span>
        </div>
        {{/with}}
      </div>
    </div>
    {{/with}}
    {{#if showForm}}
      {{> featureKeyUploadForm successCb=hideFormCb }}
    {{else}}
      <div class="feature-key-button-row">
        <button class="button-primary feature-key-upload-button">Upload new feature key...</button>
        <button class="button-secondary feature-key-delete-button">Delete feature key</button>
      </div>
    {{/if}}

    <p><a href="{{settingsPath}}">Go to the settings page to configure Sandstorm for Work features.</a></p>

  {{else}}
    <h4>Upload feature key</h4>
    <p>To make use of Sandstorm for Work features like LDAP and SAML login and organization
      management, enter your feature key.</p>
    {{> featureKeyUploadForm }}

    <h4>Don't have one?</h4>
    <p>Sandstorm for Work adds LDAP support, with more features arriving soon.</p>
    <a class="button-secondary request-feature-key"
       target="_blank"
       href="https://sandstorm.io/get-feature-key">
       Request a feature key
    </a>
  {{/if}}
</template>

<template name="featureKeyUploadForm">
  <form class="feature-key-form">
    {{#with error=currentError}}
      {{#if error}}
        <div class="flash-message error-message">Error: {{error}}</div>
      {{/if}}
    {{/with}}
    <label>Feature key:
    <textarea class="feature-key" placeholder="Paste feature key here..."></textarea>
    </label>
    <div class="feature-key-button-row">
      <button class="check-key">Verify</button>
    </div>
    <label>Or select a file to upload: <input name="feature-key" type="file" /></label>
  </form>
</template>

<template name="appdemo">
  {{> drydemo}}
</template>

<template name="demo">
  {{> drydemo}}
</template>

<template name="drydemo">
  {{>title pageTitle}}

  <div class="demo-box">
    {{#if allowDemo}}
      {{#if appName}}
        <h2><a href="https://sandstorm.io" target="_blank">Sandstorm</a> is an open source platform for running apps like {{appName}}.</h2>
      {{else}}
        <h2><a href="https://sandstorm.io" target="_blank">Sandstorm</a> is an open source platform for personal instances of web apps.</h2>
      {{/if}}

      <button class="start">
        {{#if appName}}
          Try {{appName}} &#9654;
        {{else}}
          Try a quick demo &#9654;
        {{/if}}
      </button>

      <p>Sandstorm makes it easy to run apps on your own server. In addition to improving privacy and control, <a href="https://blog.sandstorm.io/news/2014-07-21-open-source-web-apps-require-federated-hosting.html" target="_blank">this is the only way to make Open Source web apps viable.</a></p>
      <p>Sandstorm is also <strong>ridiculously secure</strong>. If security interests you, check out <a href="https://docs.sandstorm.io/en/latest/developing/security-practices/" target="_blank">Sandstorm's security model overview</a>.</p>
    {{else}}
      <p>Sorry, this server does not allow demo accounts.</p>
    {{/if}}
  </div>
</template>

<template name="referrals">
  {{#if quotaEnabled}}
  {{>title "Referral Program"}}
  {{setDocumentTitle}}
  <div class="referrals">
    <h1>Referral Program</h1>
    <header>
      {{#if isPaid}}
      <h2>Get up to <span class="reward-amount">30 GB</span> of free space when your friends share on Oasis!</h2>
      {{else}}
      <h2>Get unlimited grains &amp; up to <span class="reward-amount">2 GB</span> of free space when
        your friends share on Oasis!</h2>
      {{/if}}

      {{#if isPaid}}
      <p>
        For each friend that creates a sharing link, we'll reward you with 2 GB.
      </p>
      {{else}}
      <p>
        For each friend that creates a sharing link, we'll reward you with 50 MB.
        You'll also get unlimited grains.
      </p>
      {{/if}}
    </header>
    <section>
      <h1>Sharing is referring</h1>
      <p>To get started, open any grain and click Share access.</p>

      <div class="image-tutorial">
      <ol>
        <li>You share a grain with your friend (who isn't already an Oasis user).
          <img src="/referral-graphics/referral-1.svg">
        </li>
        <li>Your friend signs in.
          <img src="/referral-graphics/referral-2.svg">
        </li>
        <li>Your friend shares a grain with any other person (including you).
          <img src="/referral-graphics/referral-3.svg">
        </li>
      </ol>

      </div>

      {{#if currentUser}}
      <h2>Your referrals &amp; status</h2>

      <p>Once you send a sharing link out, people will appear in this list
        after they sign in.</p>

      {{#with notYetCompleteReferralNames}}{{#if this.count}}
      <h3>Still needs to share</h3>

      <p class="gentle-hint">Tell these people to make a grain and share it with you. You
        must actually view the grain they shared with you!</p>

      <ul class="comma-separated-ul">
        {{#each this}}
        <li>{{name}}</li>
        {{/each}}
      </ul>

      {{/if}}{{/with}}

      {{#with completeReferralNames}}{{#if this.count}}
      <h3>Successful referrals</h3>

      <p class="gentle-hint">You've successfully referred these people. Congratulations!</p>

      <ul class="comma-separated-ul">
        {{#each this}}
        <li>{{name}}</li>
        {{/each}}
      </ul>

      {{/if}}{{/with}}

      <h2 class="fine-print">The fine print</h2>

      <p>Your referral bonus lasts until 1 year after the
          referral. The terms of this referral program may
          change without warning; however, such changes will not affect
          bonuses you have already received. If you need even more
          space, <a href="{{pathFor route='account'}}">upgrade your
          account.</a>
      </p>

      <p>Paid subscribers can get up to 30 GB of free storage, 2 GB per
        person they refer, in addition to the storage from their
        account level. Free account holders can earn unlimited grains
        and 50 MB of free storage per person they refer, up to 2 GB
        total.</p>

      {{/if}}
    </section>
  </div>
  {{/if}}
</template>

<template name="about">
  {{setDocumentTitle}}
  {{>title "About Sandstorm"}}

  <div class="about">
    <h1>About Sandstorm</h1>

    <section class="intro">
      <p><a href="https://sandstorm.io">Sandstorm.io</a> is an open source hosting platform for
        personal/private instances of web apps. Users can upload and install arbitrary software
        through a simple app-store-like web interface. In addition to better privacy,
        <a href="https://blog.sandstorm.io/news/2014-07-21-open-source-web-apps-require-federated-hosting.html">
        this is the only way to make Open Source web apps viable.</a></p>

      <p class="version">Version: {{build}}</p>
      {{#if isUnofficial}}
        <p class="unofficial"><b>WARNING:</b> This server is running an unofficial build of Sandstorm which may contain modifications not reviewed by the developers.</p>
      {{/if}}
    </section>

    <section class="changelog">
      <h2>Recent Changes</h2>

      {{> changelog}}
    </section>

    <section class="developers">
      <h2>Core Developers</h2>
      <ul>
        <li><a href="https://github.com/kentonv">
            <img src="/logos/kenton.png" alt="Kenton Varda">
            Kenton Varda</a></li><li>
        <a href="https://github.com/jadeqwang">
            <img src="/logos/jade.png" alt="Jade Wang">
            Jade Wang</a></li><li>
        <a href="https://github.com/jparyani">
            <img src="/logos/jason.png" alt="Jason Paryani">
            Jason Paryani</a></li><li>
        <a href="https://github.com/dwrensha">
            <img src="/logos/david.png" alt="David Renshaw">
            David Renshaw</a></li><li>
        <a href="https://github.com/paulproteus">
            <img src="/logos/asheesh.png" alt="Asheesh Laroia">
            Asheesh Laroia</a></li><li>
        <a href="http://nenanguyen.ca">
            <img src="/logos/nena.png" alt="NÃ©na Nguyá»…n">
            NÃ©na Nguyá»…n</a></li><li>
        <a href="https://github.com/zarvox">
            <img src="/logos/drew.png" alt="Drew Fisher">
            Drew Fisher</a></li><li>
        <a href="https://plus.google.com/u/0/114357619139436426265">
            <img src="/logos/garply.png" alt="Garply">
            Garply</a></li>
      </ul>
    </section><section class="advisors">
      <h2>Advisors</h2>
      <ul>
        <li><a href="https://github.com/swetland">
            <img src="/logos/swetland.png" alt="Brian Swetland">
            Brian Swetland</a></li><li>
        <a href="https://github.com/amluto">
            <img src="/logos/luto.png" alt="Andrew Lutomirski">
            Andrew Lutomirski</a></li><li>
        <a href="https://github.com/jasvir">
            <img src="/logos/jasvir.png" alt="Jasvir Nagra">
            Jasvir Nagra</a></li><li>
        <a href="https://github.com/mseaborn">
            <img src="/logos/seaborn.png" alt="Mark Seaborn">
            Mark Seaborn</a></li><li>
        <a href="http://en.wikipedia.org/wiki/Mark_S._Miller">
            <img src="/logos/miller.png" alt="Mark Miller">
            Mark Miller</a></li>
      </ul>
    </section>
    <br>
    <section class="corporate">
      <h2>Corporate Sponsors</h2>
      <p>These companies contributed heavily to Sandstorm's <a href="http://igg.me/at/sandstorm">crowdfunding campaign</a>.</p>
      <ul>
        <li><a href="http://draw.io"><img width="92.75" height="121" src="/logos/draw.io-logo.svg">&nbsp;</a></li><li>
        <img src="/logos/humanweb.png">&nbsp;</li><li>
        <a href="https://uniregistry.com"><div class="uniregistry-image"></div>&nbsp;</a></li>
      </ul>
      <div class="strut"></div>
    </section><section class="individual">
      <h2>Key Invididual Sponsors</h2>
      <p>These individuals contributed heavily to Sandstorm's <a href="http://igg.me/at/sandstorm">crowdfunding campaign</a>.</p>
      <ul>
      <li><a href="http://rogerwagner.com/">
          <img src="/logos/wagner.png">
          Roger Wagner</a></li><li>
      <a href="https://github.com/audreyt">
          <img src="/logos/audrey.png">
          Audrey Tang</a></li>
      </ul>
    </section>

    <section class="backers">
      <h2>Backers</h2>
      <p>from <a href="http://igg.me/at/sandstorm">our Indiegogo campaign &gt;</a></p>
      {{#if backers}}
      <ul>
        {{#each backers}}
          <li>{{.}}</li>
        {{/each}}
        <li>&nbsp;</li>
        <li>&nbsp;</li>
        <li>&nbsp;</li>
        <li class="anonymous">and {{anonCount}} anonymous contributors</li>
      </ul>
      {{else}}
      <p>loading...</p>
      {{/if}}
    </section>

    <section class="dependencies">
      <h2>Third-party works used</h2>
      <ul>
        <!-- TODO(soon): This list has a lot missing. Review. -->
        <li><a href="http://nodejs.org/">Node.js</a> (MIT license)</li>
        <li><a href="https://www.meteor.com/">Meteor web framework</a> (MIT license)</li>
        <li><a href="https://github.com/jedisct1/libsodium">libsodium</a> (ISC license)</li>
        <li><a href="https://github.com/seccomp/libseccomp">libseccomp</a> (LGPL license)</li>
        <li><a href="https://www.mongodb.org/">MongoDB</a> (AGPL)</li>
        <li><a href="https://github.com/EventedMind/iron-router">Iron Router</a> (MIT license)</li>
        <li><a href="http://underscorejs.org/">Underscore.js</a> (MIT license)</li>
        <li><a href="http://www.senchalabs.org/connect/">Connect middleware</a> (MIT license)</li>
        <li><a href="https://www.npmjs.org/package/es6-promises">ES6-Promise polyfill by Dmitry Korobkin</a> (MIT license)</li>
        <li><a href="https://www.google.com/fonts/specimen/Source+Sans+Pro">Source Sans Pro font</a> (SIL OFL)</li>
        <li><a href="https://github.com/joyent/http-parser">Node/nginx HTTP parser library</a> (MIT license)</li>
        <li><a href="https://github.com/andris9/simplesmtp">Simple SMTP by Andris Reinman</a> (MIT license)</li>
        <li><a href="https://github.com/justmoon/node-bignum">node-bignum by Stefan Thomas</a> (MIT license)</li>
        <li><a href="https://github.com/drudru/ansi_up">ansi_up library by Dru Nelson</a> (MIT license)</li>
        <li><a href="https://github.com/stewartlord/identicon.js">identicon.js by Stewart Lord</a> (BSD license)</li>
        <li><a href="https://github.com/usablica/intro.js">intro.js by Afshin Mehrabani</a> (MIT license)</li>
        <li><a href="http://www.xarg.org/2010/03/generate-client-side-png-files-using-javascript/">PNGlib by Robert Eisele</a> (BSD license)</li>
        <li><a href="http://libb64.sourceforge.net/">libb64 by Chris Venter</a> (Public Domain)</li>
        <li><a href="http://tukaani.org/xz/">XZ Utils</a> (Public Domain / GPL)</li>
        <li><a href="http://www.info-zip.org/">Info-ZIP</a> (Info-ZIP license)</li>
        <li><a href="http://www.gnu.org/software/libc/libc.html">GNU C library</a> (LGPL license)</li>
        <li><a href="https://gcc.gnu.org/libstdc++/">GNU C++ Library</a> (LGPL license)</li>
        <li class="spacer">&nbsp;</li>
        <li class="spacer">&nbsp;</li>
        <li class="spacer">&nbsp;</li>
      </ul>
      <p>These works are copyright the respective authors and used under the terms of the respective
        licenses.</p>
    </section>

    <section class="copyright">
      <h2>Copyright</h2>
      <p>The Sandstorm implementation is copyright by Sandstorm Development Group, Inc. and
         contributors. The implementation is licensed under the Apache License 2.0.</p>
      <p>"Sandstorm" and the Sandstorm logo are trademarks of Sandstorm Development Group, Inc.,
         and may not be used to advertise derivative works nor commercial services without
         written consent from Sandstorm Development Group, Inc.</p>
    </section>

    <section class="terms">
      <ul>
        <li><a href="https://github.com/sandstorm-io/sandstorm/blob/master/LICENSE">License</a></li>
        {{#with termsUrl}}<li><a href="{{.}}">Terms of Service</a></li>{{/with}}
        {{#with privacyUrl}}<li><a href="{{.}}">Privacy Policy</a></li>{{/with}}
      </ul>
    </section>
  </div>
</template>
